{
  "feature": "Rust Parser CLI",
  "branch": "ralph/rust-parser",
  "patterns": [
    "Rust must be sourced from ~/.cargo/env before cargo commands will work",
    "jomini text::de::from_utf8_slice requires target type annotation (HashMap<String, Value>)",
    "Use a shared error.rs module for JSON error output to stderr with exit codes (1=file not found, 2=parse error, 3=invalid argument)",
    "jomini HashMap<String, Value> deserialization overwrites duplicate keys (last value wins); use TextTape or custom deserializers for duplicate preservation",
    "Condensed syntax parsing works when quoted strings provide delimiters (a={b=\"1\"c=\"2\"}); bare values adjacent to bare values may concatenate",
    "Stellaris saves use Windows-1252 encoding, not UTF-8; use jomini's from_windows1252_slice() for lossless decoding to Unicode",
    "Use clap's try_parse() instead of parse() for custom exit codes; parse() always exits 2 for errors, try_parse() lets you control exit code",
    "Use PARSER_BINARY environment variable to override binary path in tests and custom deployments",
    "SaveExtractorBase is in stellaris_save_extractor/base.py, not backend/extractors/base.py; save_extractor.py is a compatibility shim"
  ],
  "stories": [
    {
      "id": "RUST-001",
      "title": "Initialize Rust project with jomini dependency",
      "criteria": [
        "RUN: ls stellaris-parser/Cargo.toml (file exists)",
        "RUN: grep 'jomini' stellaris-parser/Cargo.toml (shows 0.28 or higher)",
        "RUN: grep -A3 '\\[profile.release\\]' stellaris-parser/Cargo.toml (shows lto, codegen-units, strip)",
        "RUN: ls stellaris-parser/src/main.rs stellaris-parser/src/commands/mod.rs (files exist)",
        "RUN: cd stellaris-parser && cargo build --release (exit code 0)",
        "RUN: cd stellaris-parser && cargo run -- --help (shows extract-save and iter-save subcommands)"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "RUST-002",
      "title": "Implement .sav file reading (zip extraction)",
      "criteria": [
        "RUN: cd stellaris-parser && cargo test sav_reading (unit tests pass)",
        "RUN: grep 'zip' stellaris-parser/Cargo.toml (zip crate in dependencies)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save ../test_save.sav --sections meta --output - 2>&1 (no 'failed to read' errors)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save nonexistent.sav --sections meta 2>&1; echo $? (exit code 1, JSON error on stderr)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Added sav_reading tests and JSON error output on stderr via error.rs module"
    },
    {
      "id": "RUST-003",
      "title": "Implement extract-save command for small sections",
      "criteria": [
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save test_save.sav --sections meta --output - | jq .schema_version (returns 1)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save test_save.sav --sections meta --output - | jq .tool_version (returns version string)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save test_save.sav --sections meta,galaxy --output - | jq 'keys' (contains meta and galaxy)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save test_save.sav --sections meta --output - | jq . (valid JSON, no parse error)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implementation already complete - jomini parses gamestate and meta correctly, JSON output includes schema_version, tool_version, and game fields"
    },
    {
      "id": "RUST-004",
      "title": "Implement iter-save command for large sections",
      "criteria": [
        "RUN: ./stellaris-parser/target/release/stellaris-parser iter-save test_save.sav --section country --format jsonl | head -1 | jq .schema_version (returns 1)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser iter-save test_save.sav --section country --format jsonl | head -1 | jq .section (returns 'country')",
        "RUN: ./stellaris-parser/target/release/stellaris-parser iter-save test_save.sav --section country --format jsonl | wc -l (returns > 0 lines)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser iter-save test_save.sav --section country --format jsonl | tail -1 | jq .key (returns a key string)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implementation already complete - iter-save outputs JSONL with schema_version, section, key, value on first line and key, value on subsequent lines. 66 country entries found in test_save.sav."
    },
    {
      "id": "RUST-005",
      "title": "Handle Clausewitz edge cases via Rust unit tests",
      "criteria": [
        "RUN: cd stellaris-parser && cargo test duplicate_keys (test exists and passes)",
        "RUN: cd stellaris-parser && cargo test condensed_syntax (test exists and passes)",
        "RUN: cd stellaris-parser && cargo test escape_sequences (test exists and passes)",
        "RUN: cd stellaris-parser && cargo test (all tests pass)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Added 15 tests in edge_cases.rs covering duplicate keys, condensed syntax, escape sequences, empty blocks, and mixed values. Tests document jomini's actual behavior: HashMap deserialization overwrites duplicates (last value wins), quoted strings serve as delimiters for condensed syntax."
    },
    {
      "id": "RUST-006",
      "title": "Handle encoding edge cases",
      "criteria": [
        "RUN: cd stellaris-parser && cargo test encoding (encoding tests pass)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save test_save.sav --sections species_db --output - | grep -v 'error' (no encoding errors)",
        "Code review: src/output.rs handles non-UTF8 bytes (escapes or lossy conversion documented)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Created src/output.rs with comprehensive encoding documentation. Changed extract.rs and iter.rs to use jomini's from_windows1252_slice() instead of from_utf8_slice(). Added 6 encoding tests covering Windows-1252 special characters (0x80-0x9F range), high bytes (0xA0-0xFF), color codes, and ASCII passthrough. Windows-1252 is a lossless conversion to Unicode."
    },
    {
      "id": "RUST-007",
      "title": "Implement proper error handling and exit codes",
      "criteria": [
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save test_save.sav --sections meta --output -; echo \"exit:$?\" (shows exit:0)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save nonexistent.sav --sections meta 2>&1; echo \"exit:$?\" (shows exit:1 and JSON on stderr)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save 2>&1; echo \"exit:$?\" (shows exit:3 for missing args)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save test_save.sav --sections meta 2>&1 | wc -l (stderr is 0-1 lines on success)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Custom clap error handling in main.rs - use try_parse() instead of parse() and exit(3) for argument errors to match architecture spec"
    },
    {
      "id": "RUST-008",
      "title": "Add --schema-version flag support",
      "criteria": [
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save test_save.sav --sections meta --schema-version 1 --output - | jq .schema_version (returns 1)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save test_save.sav --sections meta --output - | jq .schema_version (returns 1, default)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser extract-save test_save.sav --sections meta --schema-version 999 2>&1; echo $? (exit code 3)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Already implemented in previous iterations - CLI accepts --schema-version flag with default of 1, validates against supported versions, and exits with code 3 for invalid versions"
    },
    {
      "id": "RUST-009",
      "title": "Implement extract-gamestate debug command",
      "criteria": [
        "RUN: unzip -p test_save.sav gamestate > /tmp/gamestate_test && ./stellaris-parser/target/release/stellaris-parser extract-gamestate /tmp/gamestate_test --sections galaxy --output - | jq .galaxy (returns object)",
        "RUN: ./stellaris-parser/target/release/stellaris-parser --help | grep extract-gamestate (command documented)",
        "Code review: extract-gamestate marked as debug in help text"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Already implemented - run_gamestate function in extract.rs reads raw gamestate file directly without ZIP extraction. Help text includes '(debug only)' suffix."
    },
    {
      "id": "INT-001",
      "title": "Create rust_bridge.py Python integration",
      "criteria": [
        "RUN: ls rust_bridge.py || ls backend/rust_bridge.py (file exists)",
        "RUN: python -c \"from rust_bridge import extract_sections; print(type(extract_sections('test_save.sav', ['meta'])))\" (returns <class 'dict'>)",
        "RUN: python -c \"from rust_bridge import iter_section_entries; print(list(iter_section_entries('test_save.sav', 'country'))[:1])\" (returns list with tuple)",
        "RUN: python -c \"from rust_bridge import ParserError; print(ParserError.__bases__)\" (exception class exists)",
        "RUN: grep 'timeout=60' rust_bridge.py || grep 'timeout=60' backend/rust_bridge.py (60 second timeout set)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Created rust_bridge.py with extract_sections(), iter_section_entries(), ParserError, and _get_binary_path(). Binary lookup searches development path first, then bin/ folder."
    },
    {
      "id": "INT-002",
      "title": "Add fallback detection when binary missing",
      "criteria": [
        "RUN: python -c \"from rust_bridge import _get_binary_path; print(_get_binary_path())\" (returns path string)",
        "RUN: PARSER_BINARY=/nonexistent python -c \"from rust_bridge import extract_sections; extract_sections('test.sav', ['meta'])\" 2>&1 (raises FileNotFoundError)",
        "Code review: rust_bridge.py checks binary exists before subprocess call"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Added PARSER_BINARY environment variable support for testing and custom deployments. Binary existence is already checked before subprocess calls in both extract_sections() and iter_section_entries()."
    },
    {
      "id": "MIG-001",
      "title": "Update SaveExtractorBase to use Rust bridge",
      "criteria": [
        "RUN: grep 'rust_bridge' backend/extractors/base.py || grep 'rust_bridge' save_extractor.py (import present)",
        "RUN: grep 'gamestate_path' backend/extractors/base.py || grep 'gamestate_path' save_extractor.py (path stored)",
        "RUN: grep -A2 'ParserError' backend/extractors/base.py || grep -A2 'ParserError' save_extractor.py (fallback logic present)",
        "RUN: python -m pytest tests/ -v (existing tests pass)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Added rust_bridge import and gamestate_path property to stellaris_save_extractor/base.py. Re-exported ParserError in save_extractor.py for compatibility. _get_building_types method now uses Rust bridge with regex fallback."
    },
    {
      "id": "MIG-002",
      "title": "Migrate building extraction to Rust bridge",
      "criteria": [
        "RUN: grep 'extract_sections.*buildings' stellaris_save_extractor/base.py (Rust call present in _get_building_types)",
        "RUN: grep -A30 'def _get_building_types' stellaris_save_extractor/base.py | grep -E '(extract_sections|ParserError)' (uses Rust with fallback)",
        "RUN: venv/bin/python -m pytest tests/ -v -k building (building tests pass if they exist)",
        "RUN: venv/bin/python -m pytest tests/ -v (all tests still pass)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implementation was completed in MIG-001. Criteria paths corrected from backend/extractors/*.py and save_extractor.py to stellaris_save_extractor/base.py where SaveExtractorBase actually lives. _get_building_types uses extract_sections with ParserError fallback to regex."
    },
    {
      "id": "MIG-003",
      "title": "Migrate remaining extraction modules",
      "criteria": [
        "RUN: grep -r 'extract_sections' stellaris_save_extractor/ | wc -l (at least 1 usage)",
        "RUN: grep -r 'ParserError' stellaris_save_extractor/ | wc -l (fallback present)",
        "RUN: venv/bin/python -m pytest tests/ -v (all tests pass)",
        "RUN: venv/bin/python v2_native_tools.py test_save.sav --briefing 2>&1 | head -20 (briefing still works)"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Added Rust bridge to _get_species_names() method in base.py with regex fallback. Now 4 extract_sections usages (buildings, species_db) and 5 ParserError usages in stellaris_save_extractor/. All 51 tests pass."
    },
    {
      "id": "BUILD-001",
      "title": "Create GitHub Actions workflow for cross-platform builds",
      "criteria": [
        "RUN: ls .github/workflows/rust-parser.yml (file exists)",
        "RUN: grep 'windows' .github/workflows/rust-parser.yml (Windows build configured)",
        "RUN: grep 'macos' .github/workflows/rust-parser.yml (macOS build configured)",
        "RUN: grep 'ubuntu' .github/workflows/rust-parser.yml (Linux build configured)",
        "RUN: grep -E 'push:.*tags|workflow_dispatch' .github/workflows/rust-parser.yml (trigger configured)"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "DIST-001",
      "title": "Bundle binary in Python package structure",
      "criteria": [
        "RUN: ls bin/ || ls backend/bin/ (bin directory exists)",
        "RUN: grep 'bin/' rust_bridge.py || grep 'bin/' backend/rust_bridge.py (binary path includes bin/)",
        "RUN: ls README.md && grep -i 'binary\\|stellaris-parser' README.md (documented)"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "DIST-002",
      "title": "Bundle binary in Electron app",
      "criteria": [
        "RUN: ls electron/ || ls specs/electron-app/ (Electron app exists)",
        "RUN: grep -r 'stellaris-parser' electron/ || grep -r 'stellaris-parser' specs/electron-app/ (binary referenced)",
        "Code review: rust_bridge.py handles Electron resources path"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Depends on Electron app existing - skip if no Electron yet"
    },
    {
      "id": "TEST-001",
      "title": "Create comprehensive Rust test suite",
      "criteria": [
        "RUN: ls test_save.sav (test save exists in project root)",
        "RUN: cd stellaris-parser && cargo test (all Rust tests pass)",
        "RUN: cd stellaris-parser && cargo test -- --list 2>&1 | grep -c test (at least 5 tests)",
        "RUN: venv/bin/python -c \"from rust_bridge import extract_sections; d=extract_sections('test_save.sav', ['meta']); assert 'meta' in d\" (Python integration works)"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    }
  ],
  "discovered": []
}
