{
  "feature": "Rust Parser Migration",
  "branch": "ralph/rust-migration",
  "patterns": [
    "Use venv/bin/python or python3 - bare python doesn't exist",
    "Extractors are in stellaris_save_extractor/ not backend/extractors/",
    "Always capture baseline BEFORE changing code",
    "Planet names use key/variables structure - extract from variables for real name",
    "Species names similarly need variable extraction",
    "extract_sections() returns dict, iter_section_entries() yields (key, value) tuples",
    "Faction names also use key/variables structure - recursively extract deepest meaningful name from nested variables",
    "planets section has nested structure: data['planets']['planet'][id] for individual planets",
    "starbase_mgr section has nested structure: data['starbase_mgr']['starbases'][id] for individual starbases",
    "Base helper methods (_find_section_bounds, _extract_nested_block) can remain regex-based - they're utilities not main extractors",
    "Country names use same key/variables structure as factions - use recursive extraction for template names"
  ],
  "stories": [
    {
      "id": "SETUP-001",
      "title": "Create validation infrastructure and capture all baselines",
      "criteria": [
        "RUN: python3 scripts/capture_baseline.py --list (shows available methods)",
        "RUN: python3 scripts/capture_baseline.py get_player_status (baseline saved)",
        "RUN: python3 scripts/capture_baseline.py get_planets (baseline saved)",
        "RUN: python3 scripts/capture_baseline.py get_fleets (baseline saved)",
        "RUN: python3 scripts/capture_baseline.py get_diplomacy (baseline saved)",
        "RUN: python3 scripts/capture_baseline.py get_resources (baseline saved)",
        "RUN: python3 scripts/capture_baseline.py get_species_full (baseline saved)",
        "RUN: python3 scripts/capture_baseline.py get_leaders (baseline saved)",
        "RUN: python3 scripts/capture_baseline.py get_technology (baseline saved)",
        "RUN: python3 scripts/capture_baseline.py get_armies (baseline saved)",
        "RUN: python3 scripts/capture_baseline.py get_metadata (baseline saved)",
        "RUN: ls tests/migration_baselines/*.json | wc -l (at least 10 baseline files)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Completed: All 10 baselines captured successfully (get_player_status, get_planets, get_fleets, get_diplomacy, get_resources, get_species_full, get_leaders, get_technology, get_armies, get_metadata)"
    },
    {
      "id": "MIG-PLAYER",
      "title": "Migrate player.py to Rust parser",
      "criteria": [
        "RUN: python3 scripts/capture_baseline.py get_player_status (baseline exists)",
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/player.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/player.py (fallback present)",
        "RUN: python3 scripts/validate_migration.py get_player_status --update (matches or improves, baseline updated if improved)",
        "RUN: python3 -c 'from save_extractor import SaveExtractor; print(SaveExtractor(\"test_save.sav\").get_player_status())' (no errors)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Migrated get_player_empire_id, get_empire_identity, get_traditions, get_ascension_perks, get_relics to Rust parser with regex fallback"
    },
    {
      "id": "MIG-PLANETS",
      "title": "Migrate planets.py to Rust parser",
      "criteria": [
        "RUN: python3 scripts/capture_baseline.py get_planets (baseline exists)",
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/planets.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/planets.py (fallback present)",
        "RUN: python3 scripts/validate_migration.py get_planets --update (matches or improves, baseline updated if improved)",
        "RUN: python3 -c 'from save_extractor import SaveExtractor; e=SaveExtractor(\"test_save.sav\"); print(len(e.get_planets()))' (returns count)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Migrated with Rust parser. Planet names now properly resolved: NEW_COLONY_NAME_X -> 'SystemName X', HABITAT_PLANET_NAME -> 'SystemName Habitat'"
    },
    {
      "id": "MIG-MILITARY",
      "title": "Migrate military.py to Rust parser",
      "criteria": [
        "RUN: python3 scripts/capture_baseline.py get_fleets (baseline exists)",
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/military.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/military.py (fallback present)",
        "RUN: python3 scripts/validate_migration.py get_fleets --update (matches or improves, baseline updated if improved)",
        "RUN: python3 -c 'from save_extractor import SaveExtractor; print(SaveExtractor(\"test_save.sav\").get_fleets().keys())' (no errors)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Migrated get_fleets to Rust parser using iter_section_entries for fleet iteration. Validation passes - output matches baseline exactly."
    },
    {
      "id": "MIG-DIPLOMACY",
      "title": "Migrate diplomacy.py to Rust parser",
      "criteria": [
        "RUN: python3 scripts/capture_baseline.py get_diplomacy (baseline exists)",
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/diplomacy.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/diplomacy.py (fallback present)",
        "RUN: python3 scripts/validate_migration.py get_diplomacy --update (matches or improves, baseline updated if improved)",
        "RUN: python3 -c 'from save_extractor import SaveExtractor; print(len(SaveExtractor(\"test_save.sav\").get_diplomacy()))' (returns count)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Migrated get_diplomacy to Rust parser for federation ID extraction. Uses hybrid approach: Rust parser for country iteration to get federation ID, regex for relations_manager parsing due to duplicate 'relation' keys (Rust parser collapses duplicate keys)."
    },
    {
      "id": "MIG-ECONOMY",
      "title": "Migrate economy.py to Rust parser",
      "criteria": [
        "RUN: python3 scripts/capture_baseline.py get_resources (baseline exists)",
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/economy.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/economy.py (fallback present)",
        "RUN: python3 scripts/validate_migration.py get_resources --update (matches or improves, baseline updated if improved)",
        "RUN: python3 -c 'from save_extractor import SaveExtractor; print(SaveExtractor(\"test_save.sav\").get_resources().keys())' (no errors)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "get_resources already migrated to Rust parser using iter_section_entries for country iteration. Extracts stockpiles from standard_economy_module.resources and budget data from country.budget.current_month. Validation passes - output matches baseline exactly."
    },
    {
      "id": "MIG-SPECIES",
      "title": "Migrate species.py to Rust parser",
      "criteria": [
        "RUN: python3 scripts/capture_baseline.py get_species_full (baseline exists)",
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/species.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/species.py (fallback present)",
        "RUN: python3 scripts/validate_migration.py get_species_full --update (matches or improves, baseline updated if improved)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Migrated get_species_full to Rust parser using iter_section_entries for species iteration. Uses hybrid approach: Rust for structured data (name, class, portrait, home_planet), regex for traits (duplicate key issue). Fixed critical bug in original code that was matching entries from other sections (pop_groups). Baseline updated - 924 species (correct) vs 1042 (incorrect due to section boundary bug)."
    },
    {
      "id": "MIG-LEADERS",
      "title": "Migrate leaders.py to Rust parser",
      "criteria": [
        "RUN: python3 scripts/capture_baseline.py get_leaders (baseline exists)",
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/leaders.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/leaders.py (fallback present)",
        "RUN: python3 scripts/validate_migration.py get_leaders --update (matches or improves, baseline updated if improved)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "get_leaders already migrated to Rust parser using iter_section_entries for leaders iteration. Uses hybrid approach: Rust for structured data (id, class, name, level, age, experience), regex for traits (duplicate key issue). Validation passes - output matches baseline exactly."
    },
    {
      "id": "MIG-TECHNOLOGY",
      "title": "Migrate technology.py to Rust parser",
      "criteria": [
        "RUN: python3 scripts/capture_baseline.py get_technology (baseline exists)",
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/technology.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/technology.py (fallback present)",
        "RUN: python3 scripts/validate_migration.py get_technology --update (matches or improves, baseline updated if improved)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "get_technology already migrated to Rust parser using iter_section_entries for country iteration to find player's tech_status. Uses hybrid approach: Rust for structured data (queues, alternatives, budget), regex for researched techs list due to duplicate technology= keys. Validation passes - output matches baseline exactly."
    },
    {
      "id": "MIG-ARMIES",
      "title": "Migrate armies.py to Rust parser",
      "criteria": [
        "RUN: python3 scripts/capture_baseline.py get_armies (baseline exists)",
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/armies.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/armies.py (fallback present)",
        "RUN: python3 scripts/validate_migration.py get_armies --update (matches or improves, baseline updated if improved)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "get_armies already migrated to Rust parser using iter_section_entries for army iteration. Filters by player owner, extracts health/morale/location/leader/species data. Validation passes - output matches baseline exactly."
    },
    {
      "id": "MIG-ENDGAME",
      "title": "Migrate endgame.py to Rust parser",
      "criteria": [
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/endgame.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/endgame.py (fallback present)",
        "RUN: python3 -c 'from save_extractor import SaveExtractor; e=SaveExtractor(\"test_save.sav\"); print(e.get_crisis_status())' (no errors)"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Migrated get_crisis_status, get_lgate_status, get_menace, get_great_khan to Rust parser using iter_section_entries for country iteration. Uses hybrid approach: Rust for structured data (country_type, name, flags), regex for gamestate-wide flag searches (crisis_systems, khan_defeated). All 4 methods have _rust and _regex variants with fallback."
    },
    {
      "id": "MIG-POLITICS",
      "title": "Migrate politics.py to Rust parser",
      "criteria": [
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/politics.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/politics.py (fallback present)",
        "RUN: python3 -c 'from save_extractor import SaveExtractor; e=SaveExtractor(\"test_save.sav\"); print(e.get_factions())' (no errors)"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Migrated get_factions to Rust parser using iter_section_entries for pop_factions iteration. Uses Rust for all structured data (type, support_percent, support_power, approval, members). Improved faction name resolution - now extracts actual names from nested variable structures instead of showing raw %ADJ% keys. Regex fallback (_get_factions_regex) preserved for error cases."
    },
    {
      "id": "MIG-PROJECTS",
      "title": "Migrate projects.py to Rust parser",
      "criteria": [
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/projects.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/projects.py (fallback present)",
        "RUN: python3 -c 'from save_extractor import SaveExtractor; e=SaveExtractor(\"test_save.sav\"); print(e.get_special_projects())' (no errors)"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Migrated get_special_projects to Rust parser using iter_section_entries for country iteration to get player flags. Uses hybrid approach: Rust for precursor flags from country data, regex for active projects and completed chains (duplicate key issue). Precursor progress checks both flags and completed_event_chain entries for stage detection."
    },
    {
      "id": "MIG-LEVIATHANS",
      "title": "Migrate leviathans.py to Rust parser",
      "criteria": [
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/leviathans.py (Rust calls present)",
        "RUN: grep 'ParserError' stellaris_save_extractor/leviathans.py (fallback present)",
        "RUN: python3 -c 'from save_extractor import SaveExtractor; e=SaveExtractor(\"test_save.sav\"); print(e.get_leviathans())' (no errors)"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Migrated get_leviathans to Rust parser using iter_section_entries for country iteration to detect leviathan countries by type. Uses hybrid approach: Rust for country iteration (tiyanki, crystal, amoeba, cloud, drone), regex for guardian detection (ether_drake, dimensional_horror, etc.) and defeat flag searches. Regex fallback (_get_leviathans_regex) preserved for error cases."
    },
    {
      "id": "MIG-BASE",
      "title": "Complete base.py migration (remaining regex)",
      "criteria": [
        "RUN: grep 'extract_sections\\|iter_section_entries' stellaris_save_extractor/base.py | wc -l (at least 5 usages)",
        "RUN: grep 'ParserError' stellaris_save_extractor/base.py (fallback present)",
        "RUN: python3 -c 'from save_extractor import SaveExtractor; e=SaveExtractor(\"test_save.sav\"); print(e.get_metadata())' (no errors)",
        "RUN: python3 -c 'from save_extractor import SaveExtractor; e=SaveExtractor(\"test_save.sav\"); print(len(e._get_country_names_map()))' (country names work)"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Migrated 5 base methods to Rust parser: _get_country_names_map (iter_section_entries for country iteration), _get_player_planet_ids (extract_sections for planets), _get_pop_ids_for_planets (extract_sections for planets.planet), _count_player_starbases (extract_sections for starbase_mgr), _get_ship_to_fleet_mapping (iter_section_entries for ships). All methods have _rust and _regex fallback variants. Regex fallback remains for utility methods (_find_section_bounds, _extract_nested_block) and complex fleet analysis. 8 Rust usages, ParserError fallbacks present throughout."
    },
    {
      "id": "VALIDATE-ALL",
      "title": "Final validation - all extractions work correctly",
      "criteria": [
        "RUN: python3 -c 'from save_extractor import SaveExtractor; e=SaveExtractor(\"test_save.sav\"); s=e.get_player_status(); print(\"Player:\", s.get(\"empire_name\"), \"Power:\", s.get(\"military_power\"))' (player status works)",
        "RUN: python3 -c 'from save_extractor import SaveExtractor; e=SaveExtractor(\"test_save.sav\"); p=e.get_planets(); f=e.get_fleets(); print(\"Planets:\", len(p.get(\"planets\",[])), \"Fleets:\", len(f.get(\"fleets\",[])))' (counts look reasonable)",
        "RUN: grep -r 'extract_sections\\|iter_section_entries' stellaris_save_extractor/*.py | wc -l (at least 15 usages)",
        "RUN: grep -l 'ParserError' stellaris_save_extractor/*.py | wc -l (most files have fallback)"
      ],
      "priority": 3,
      "passes": true,
      "notes": "All major extraction methods work with Rust parser. 49 Rust usages across 14 files. All files have ParserError fallback. Planets: 32, Fleets: 10. Player status, diplomacy, and all other extraction methods verified working."
    }
  ],
  "discovered": []
}
