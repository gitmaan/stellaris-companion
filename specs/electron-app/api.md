# Electron App - API Specification

## Server Configuration

- **Host**: 127.0.0.1 (localhost only)
- **Port**: 8742 (MVP fixed; detect in-use and fail gracefully)
- **Auth**: All endpoints require `Authorization: Bearer <token>`
- **Token**: Random 32-byte hex string generated by Electron at launch

## Environment Variables (Passed from Electron)

| Variable | Required | Description |
|----------|----------|-------------|
| `GOOGLE_API_KEY` | Yes | Gemini API key |
| `STELLARIS_SAVE_PATH` | No | Override save directory |
| `STELLARIS_DB_PATH` | Yes (packaged) | SQLite database location |
| `STELLARIS_API_TOKEN` | Yes | Bearer token for auth |
| `STELLARIS_API_PORT` | No | Override port (default 8742) |
| `DISCORD_BOT_TOKEN` | No | If Discord bot enabled |

## Endpoints

### Health Check

```
GET /api/health

Response 200:
{
  "status": "ok",
  "save_loaded": true,
  "empire_name": "United Nations of Earth",
  "game_date": "2250.03.15",
  "precompute_ready": true
}

Response 200 (no save):
{
  "status": "ok",
  "save_loaded": false,
  "empire_name": null,
  "game_date": null,
  "precompute_ready": false
}
```

### Chat

```
POST /api/chat
Content-Type: application/json

Request:
{
  "message": "What should I research next?",
  "session_key": "default"  // optional, for conversation history
}

Response 200:
{
  "text": "Based on your current technology...",
  "game_date": "2250.03.15",
  "tools_used": ["get_snapshot"],
  "response_time_ms": 1234
}

Response 503 (precompute not ready):
{
  "error": "Briefing not ready yet",
  "retry_after_ms": 2000
}
```

### Empire Status

```
GET /api/status

Response 200:
{
  "empire_name": "United Nations of Earth",
  "game_date": "2250.03.15",
  "military_power": 12500,
  "economy": {
    "energy": { "income": 150, "expense": 120, "net": 30 },
    "minerals": { "income": 200, "expense": 180, "net": 20 },
    "alloys": { "income": 50, "expense": 30, "net": 20 }
  },
  "colonies": 8,
  "pops": 156,
  "active_wars": 0
}
```

### Sessions

```
GET /api/sessions

Response 200:
{
  "sessions": [
    {
      "id": "abc123",
      "empire_name": "United Nations of Earth",
      "started_at": 1705420800,
      "ended_at": null,
      "first_game_date": "2200.01.01",
      "last_game_date": "2250.03.15",
      "snapshot_count": 45,
      "is_active": true
    },
    {
      "id": "def456",
      "empire_name": "Blorg Commonality",
      "started_at": 1705334400,
      "ended_at": 1705420799,
      "first_game_date": "2200.01.01",
      "last_game_date": "2280.06.01",
      "snapshot_count": 120,
      "is_active": false
    }
  ]
}
```

### Session Events

```
GET /api/sessions/{session_id}/events?limit=50

Response 200:
{
  "events": [
    {
      "id": 1,
      "game_date": "2250.03.15",
      "event_type": "technology_researched",
      "summary": "Completed research: Destroyers",
      "data": { "tech_name": "tech_destroyers", "category": "engineering" }
    },
    {
      "id": 2,
      "game_date": "2250.02.01",
      "event_type": "war_started",
      "summary": "War declared on Zroni Collective",
      "data": { "enemy": "Zroni Collective", "war_goal": "conquest" }
    }
  ]
}
```

### Generate Recap

```
POST /api/recap
Content-Type: application/json

Request:
{
  "session_id": "abc123"
}

Response 200:
{
  "recap": "# Chapter Summary: The Rise of Earth\n\n## 2200-2220: Early Expansion\n...",
  "events_summarized": 45,
  "date_range": "2200.01.01 - 2250.03.15"
}

Response 404:
{
  "error": "Session not found"
}
```

### End Session

```
POST /api/end-session

Response 200:
{
  "session_id": "abc123",
  "ended_at": 1705420800,
  "snapshot_count": 45
}

Response 400:
{
  "error": "No active session"
}
```

## Error Responses

All errors follow this format:

```json
{
  "error": "Human-readable error message",
  "code": "ERROR_CODE",  // optional
  "details": {}          // optional additional context
}
```

Common HTTP status codes:
- 400 - Bad request (invalid input)
- 401 - Missing or invalid auth token
- 404 - Resource not found
- 500 - Internal server error
- 503 - Service unavailable (e.g., precompute not ready)

## Authentication Middleware

Every request must include:
```
Authorization: Bearer <STELLARIS_API_TOKEN>
```

Requests without valid token receive:
```
HTTP 401
{
  "error": "Invalid or missing authorization token"
}
```
