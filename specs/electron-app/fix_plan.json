{
  "feature": "Electron Desktop App",
  "branch": "ralph/electron-app",
  "patterns": [
    "Reuse existing Companion, GameDatabase, SaveWatcher classes - do not reimplement",
    "All API endpoints require Bearer token auth middleware",
    "Renderer calls window.electronAPI.* only, never fetch() directly",
    "Use keytar for secrets, electron-store for non-secrets",
    "DB path must use app.getPath('userData'), not install directory",
    "Python backend spawned by Electron, not run standalone",
    "FastAPI uses Depends(verify_token) for per-route auth; access companion/db via request.app.state",
    "Use 'from __future__ import annotations' for Python 3.9+ type hint compatibility",
    "Use process.kill(-pid, 'SIGTERM') on Unix to kill process group; use taskkill on Windows for proper cleanup",
    "Electron main.js can't be tested directly with Node - ipcMain requires Electron context; verify via syntax checking and pattern matching",
    "Preload event listeners should return cleanup functions for React useEffect cleanup - e.g., return () => ipcRenderer.removeListener(channel, handler)",
    "Settings IPC should return googleApiKeySet/discordTokenSet booleans alongside masked values so UI can distinguish 'not set' from 'empty string'",
    "When saving settings, check for mask pattern (contains '...') to avoid overwriting secrets with their masked representation",
    "Vite projects must exclude vite.config.ts from main tsconfig.json - it uses tsconfig.node.json with composite: true",
    "For macOS tray, use setTemplateImage(true) on the nativeImage so it renders correctly in the menu bar; use trayTemplate.png naming convention",
    "Window minimize-to-tray requires intercepting 'close' event (not 'closed') and calling event.preventDefault() + mainWindow.hide(); use isQuitting flag to allow actual quit",
    "React hooks that call IPC should return {data, loading, error} pattern via UseBackendResult<T> for consistent error handling across components"
  ],
  "stories": [
    {
      "id": "API-001",
      "title": "Create FastAPI server with auth middleware",
      "criteria": [
        "backend/api/server.py exists with create_app() function",
        "Auth middleware rejects requests without valid Bearer token",
        "Auth middleware accepts requests with correct token",
        "python -c 'from backend.api.server import create_app' succeeds"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "API-002",
      "title": "Implement /api/health endpoint",
      "criteria": [
        "GET /api/health returns status, save_loaded, empire_name, game_date, precompute_ready",
        "Returns save_loaded=false when no save loaded",
        "Returns precompute_ready=true when briefing cached"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Already implemented in server.py lines 88-113. Verified all criteria with TestClient."
    },
    {
      "id": "API-003",
      "title": "Implement /api/chat endpoint",
      "criteria": [
        "POST /api/chat accepts {message, session_key}",
        "Returns {text, game_date, tools_used, response_time_ms}",
        "Uses companion.ask_precomputed() internally",
        "Returns 503 with retry_after_ms if precompute not ready"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented in server.py. Verified all criteria with TestClient mock tests."
    },
    {
      "id": "API-004",
      "title": "Implement /api/status endpoint",
      "criteria": [
        "GET /api/status returns empire summary",
        "Includes military_power, economy, colonies, pops, active_wars",
        "Uses companion.get_status_data() or equivalent"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented in server.py. Returns empire_name, game_date, military_power, economy (with all resources), colonies, pops, active_wars. Verified with TestClient mock tests."
    },
    {
      "id": "API-005",
      "title": "Implement /api/sessions endpoints",
      "criteria": [
        "GET /api/sessions returns list of sessions",
        "GET /api/sessions/{id}/events returns events for session",
        "Uses GameDatabase methods"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented in server.py. Added get_sessions() and get_session_by_id() methods to GameDatabase. Returns sessions with id, empire_name, started_at, ended_at, first_game_date, last_game_date, snapshot_count, is_active. Events endpoint returns id, game_date, event_type, summary, data. Verified all criteria with TestClient."
    },
    {
      "id": "API-006",
      "title": "Implement /api/recap endpoint",
      "criteria": [
        "POST /api/recap accepts {session_id}",
        "Returns {recap, events_summarized, date_range}",
        "Returns 404 if session not found"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented in server.py. Uses build_session_report_text() from reporting.py to generate a deterministic recap with key deltas and event timeline. Returns recap text, events_summarized count, and date_range string. Verified all criteria with TestClient."
    },
    {
      "id": "API-007",
      "title": "Implement /api/end-session endpoint",
      "criteria": [
        "POST /api/end-session ends current session",
        "Returns {session_id, ended_at, snapshot_count}",
        "Returns 400 if no active session"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented in server.py. Uses compute_save_id and get_active_session_id to find active session for current save. Calls end_active_sessions_for_save to end it. Returns session_id, ended_at (unix timestamp), and snapshot_count. Returns 400 with error detail if no save loaded or no active session. Verified all criteria with TestClient."
    },
    {
      "id": "API-008",
      "title": "Create electron_main.py entry point",
      "criteria": [
        "backend/electron_main.py exists",
        "Reads config from environment variables",
        "Initializes Companion with save_path and api_key",
        "Starts SaveWatcher with callback to companion.reload_save",
        "Runs FastAPI server with uvicorn",
        "python backend/electron_main.py --help or similar works"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented in backend/electron_main.py. Reads GOOGLE_API_KEY, STELLARIS_API_TOKEN, STELLARIS_DB_PATH, STELLARIS_SAVE_PATH from environment. Initializes Companion with save_path (from args, env, or auto-discovered). Starts SaveWatcher with on_save_detected callback that calls companion.reload_save(new_path=path). Runs FastAPI via uvicorn.run(). Verified --help works and import backend.electron_main succeeds."
    },
    {
      "id": "ELEC-001",
      "title": "Create Electron directory structure and package.json",
      "criteria": [
        "electron/ directory exists with correct structure",
        "package.json has all required dependencies",
        "npm install succeeds in electron/"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Created electron/ directory with main.js, preload.js, electron-builder.yml, package.json. Created renderer/ with React+TypeScript setup: App.tsx, pages/, components/, hooks/, styles/. Both npm installs succeed (electron and electron/renderer). All dependencies from overview.md spec included: electron ^28.0.0, electron-store ^8.1.0, keytar ^7.9.0, electron-builder ^24.9.0, electron-updater ^6.1.0, react ^18.2.0, vite ^5.0.0, typescript ^5.3.0."
    },
    {
      "id": "ELEC-002",
      "title": "Implement main.js with Python subprocess management",
      "criteria": [
        "main.js spawns Python backend with environment variables",
        "Generates random auth token per launch",
        "Kills Python on app quit",
        "Health checks backend on startup"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented in main.js. Uses spawn() to start Python backend with STELLARIS_API_TOKEN, GOOGLE_API_KEY, STELLARIS_DB_PATH, STELLARIS_SAVE_PATH environment variables. Generates 64-char hex auth token using crypto.randomBytes(32). Kills Python on app quit via 'will-quit' event with platform-aware process termination. Health checks via waitForBackendReady() on startup with 30s timeout, then periodic checks every 5s. IPC handlers proxy all backend:* calls through main process with auth header."
    },
    {
      "id": "ELEC-003",
      "title": "Implement preload.js with IPC bridge",
      "criteria": [
        "preload.js exposes window.electronAPI",
        "Includes settings methods (get, save, folder dialog)",
        "Includes backend proxy methods (health, chat, status, etc.)",
        "contextIsolation enabled"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented in preload.js. Uses contextBridge.exposeInMainWorld to expose electronAPI with: settings methods (getSettings, saveSettings, showFolderDialog), backend proxy (health, chat, status, sessions, sessionEvents, recap, endSession), event listeners with cleanup functions (onBackendStatus, onUpdateAvailable, onUpdateDownloaded). contextIsolation: true set in main.js BrowserWindow config. Verified syntax with node --check."
    },
    {
      "id": "ELEC-004",
      "title": "Implement IPC handlers for settings (keytar + electron-store)",
      "criteria": [
        "get-settings returns masked keys + non-secret settings",
        "save-settings stores secrets in keytar, others in electron-store",
        "show-folder-dialog opens native folder picker",
        "Settings changes restart Python backend"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented in main.js. getSettings() returns masked secrets via maskSecret() function (shows first/last 4 chars) plus googleApiKeySet/discordTokenSet booleans, and non-secrets (savePath, discordEnabled) from electron-store. saveSettings() stores secrets in keytar via setPassword() and non-secrets in electron-store. show-folder-dialog uses dialog.showOpenDialog() with openDirectory property. save-settings handler calls restartPythonBackend() after saving. Verified syntax with node --check."
    },
    {
      "id": "ELEC-005",
      "title": "Implement IPC handlers for backend API proxy",
      "criteria": [
        "backend:* handlers call Python API with auth header",
        "Handles connection errors gracefully",
        "Returns parsed JSON responses"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Already implemented in main.js (lines 419-485). All 7 backend handlers (health, chat, status, sessions, session-events, recap, end-session) use callBackendApi() which adds 'Authorization: Bearer <token>' header. All handlers wrap calls in try/catch and return {error: e.message} on failure. callBackendApi() parses JSON via response.json(). Preload.js exposes these via window.electronAPI.backend.*. Verified syntax with node --check."
    },
    {
      "id": "ELEC-006",
      "title": "Implement system tray",
      "criteria": [
        "Tray icon appears on launch",
        "Context menu has Open, Status, Quit options",
        "Click toggles window visibility",
        "macOS: app stays running when window closed"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented in main.js. Added Tray and Menu imports from Electron. createTray() creates system tray with icon from assets/trayTemplate.png (macOS) or assets/icon.png (other platforms). updateTrayMenu() builds context menu with 'Open Stellaris Companion', 'Status: Connected/Disconnected', and 'Quit' options. Tray click handler toggles window visibility via mainWindow.hide()/show(). Window close event is intercepted to hide window instead of quitting (unless isQuitting flag is set). macOS keeps running via existing window-all-closed handler that only quits on non-darwin. Health check updates tray menu periodically. Placeholder PNG icons created in assets/."
    },
    {
      "id": "UI-001",
      "title": "Create React app scaffold with Vite",
      "criteria": [
        "electron/renderer/ has React + TypeScript setup",
        "npm run dev starts Vite dev server",
        "npm run build creates production bundle",
        "App.tsx has basic routing (Chat, Recap, Settings)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "React 18.2 + TypeScript 5.3 + Vite 5.0 scaffold already existed. Fixed tsconfig.json to exclude vite.config.ts (was causing build error). npm run dev starts dev server on port 5173. npm run build creates dist/ with index.html and assets. App.tsx has tab-based navigation (useState) rendering ChatPage, RecapPage, SettingsPage components."
    },
    {
      "id": "UI-002",
      "title": "Implement StatusBar component",
      "criteria": [
        "Shows empire name and game date",
        "Shows connection status (Connected, Connecting, Disconnected)",
        "Polls backend health every 5 seconds"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented in electron/renderer/components/StatusBar.tsx. Uses useBackend().health() with 5-second polling via setTimeout pattern. Displays empire name and game date from HealthResponse. Shows connection status with color-coded indicators: Connected (green), Connecting (yellow with pulse animation), No Save (yellow), Disconnected (red). Also listens to backend-status events from main process via onBackendStatus. CSS styling added to global.css. TypeScript compiles and npm run build succeeds."
    },
    {
      "id": "UI-003",
      "title": "Implement ChatPage with ChatMessage and ChatInput",
      "criteria": [
        "ChatInput sends message on Enter",
        "ChatMessage renders user and assistant messages differently",
        "Shows loading state during API call",
        "Shows error messages on failure",
        "Messages list scrolls to bottom on new message"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented in ChatPage.tsx, ChatMessage.tsx, ChatInput.tsx. ChatInput handles Enter key via handleKeyDown callback. ChatMessage uses role-based CSS classes for different styling (user=right-aligned purple, assistant=left-aligned dark). Loading state shows animated dots indicator and disables input. Errors shown with red border styling via isError prop. Auto-scroll via useRef + scrollIntoView in useEffect on messages change. TypeScript compiles and npm run build succeeds."
    },
    {
      "id": "UI-004",
      "title": "Implement SettingsPage",
      "criteria": [
        "Shows Google API Key input (masked if set)",
        "Shows save path with Browse button",
        "Shows Discord toggle with conditional token input",
        "Save button saves settings and restarts backend",
        "First-run shows welcome message"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "UI-005",
      "title": "Implement RecapPage with SessionList and RecapViewer",
      "criteria": [
        "SessionList shows all sessions with selection",
        "Selected session shows details (dates, snapshot count)",
        "Generate Recap button calls API and shows result",
        "RecapViewer renders markdown",
        "End Current Session button works"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "UI-006",
      "title": "Implement useBackend hook",
      "criteria": [
        "useBackend() returns methods for all API calls",
        "Uses window.electronAPI.backend.* internally",
        "Handles loading states",
        "Handles errors consistently"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented in electron/renderer/hooks/useBackend.ts. Exports typed interfaces for all API responses (HealthResponse, ChatResponse, StatusResponse, etc.). Returns methods for all 7 API calls (health, chat, status, sessions, sessionEvents, recap, endSession). Uses window.electronAPI.backend.* internally via callApi() wrapper. Tracks loading state per-method via loadingStates record and isLoading(key) helper. Handles errors consistently - all methods return UseBackendResult<T> with {data, loading, error} pattern. Includes type guards isErrorResponse() and isChatRetryResponse(). TypeScript compiles and npm run build succeeds."
    },
    {
      "id": "UI-007",
      "title": "Apply dark theme styling",
      "criteria": [
        "global.css has CSS variables for colors",
        "Dark theme applied to all components",
        "Matches spec color palette"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "PKG-001",
      "title": "Create PyInstaller spec file",
      "criteria": [
        "stellaris-backend.spec exists",
        "Includes all required data files",
        "Includes hidden imports for uvicorn",
        "pyinstaller --clean stellaris-backend.spec succeeds"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "PKG-002",
      "title": "Create electron-builder.yml",
      "criteria": [
        "electron-builder.yml configures mac/win/linux targets",
        "extraResources includes Python backend",
        "App builds without signing (for now)"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "PKG-003",
      "title": "Create build scripts",
      "criteria": [
        "scripts/build-python.sh builds Python backend",
        "scripts/build-electron.sh builds Electron app",
        "scripts/build-all.sh runs both",
        "Scripts are executable"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "INT-001",
      "title": "End-to-end test: launch app, load save, ask question",
      "criteria": [
        "App launches without crash",
        "Settings page allows entering API key",
        "Backend starts after saving settings",
        "Chat page shows backend connected",
        "Asking a question returns response"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    }
  ],
  "discovered": []
}
